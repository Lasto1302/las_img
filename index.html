<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow" />
  <title>lasç§äººä½¿ç”¨</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 700px; margin: auto; }
    label, input, textarea { display: block; margin: 0.5rem 0; width: 100%; }
    img { max-width: 300px; margin-top: 1rem; border: 1px solid #ccc; }
    .urlbox { background: #f0f0f0; padding: 0.5rem; word-break: break-all; }
    .topbar { text-align: right; font-size: 0.9rem; }
    .token-warning { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="#" onclick="clearToken()">ğŸ— æ¸…é™¤ Token</a>
  </div>

  <h1>ä¸Šå‚³åœ–ç‰‡v0</h1>
  <p><a href="gallery.html">ğŸ‘‰ æŸ¥çœ‹åœ–ç‰‡ç¸½è¦½</a></p>
  <div id="tokenInputArea" style="display:none;">
    <label>è«‹è¼¸å…¥ GitHub Tokenï¼ˆåªæœƒå„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼‰</label>
    <input type="password" id="tokenInput" />
    <button onclick="saveToken()">å„²å­˜ Token</button>
  </div>

  <div id="mainApp" style="display:none;">
    <input type="file" id="file" />
    <label>è‡ªè¨‚æª”æ¡ˆåç¨±ï¼ˆå¯çœç•¥ï¼‰</label>
    <input type="text" id="filename" placeholder="ä¸å¡«å‰‡ä½¿ç”¨åŸå§‹åç¨±" />

    <label>å‚™è¨»/æè¿°ï¼ˆå¯çœç•¥ï¼‰</label>
    <textarea id="desc" placeholder="é€™å¼µåœ–ç‰‡çš„å‚™è¨»æ–‡å­—..."></textarea>

    <button onclick="upload()">ä¸Šå‚³åœ–ç‰‡</button>

    <div id="result"></div>
  </div>

  <script>
    const username = 'lasto1302';
    const repo = 'las_img';
    const branch = 'main';

    // Token ç®¡ç†
    const tokenKey = 'github_token';
    let token = localStorage.getItem(tokenKey);

    function checkToken() {
      if (!token) {
        document.getElementById('tokenInputArea').style.display = 'block';
      } else {
        document.getElementById('mainApp').style.display = 'block';
      }
    }

    function saveToken() {
      const input = document.getElementById('tokenInput').value.trim();
      if (!input) return alert('è«‹è¼¸å…¥ Token');
      localStorage.setItem(tokenKey, input);
      location.reload();
    }

    function clearToken() {
      localStorage.removeItem(tokenKey);
      location.reload();
    }

    checkToken();

async function upload() {
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  if (!file) return alert('è«‹é¸æ“‡åœ–ç‰‡');

  const reader = new FileReader();
  reader.onload = async function () {
    const base64 = reader.result.split(',')[1];
    const filenameInput = document.getElementById('filename').value.trim();
    const description = document.getElementById('desc').value.trim();

    // å–å¾—åŸå§‹å‰¯æª”å (å°å¯«)
    const originalExt = file.name.split('.').pop().toLowerCase();

    // å–å¾—æª”åï¼šä½¿ç”¨è€…è¼¸å…¥å„ªå…ˆï¼Œè‹¥ç„¡å‰¯æª”åå°±åŠ ä¸ŠåŸå§‹å‰¯æª”å
    let rawName = filenameInput || file.name;
    if (!rawName.includes('.')) {
      rawName = `${rawName}.${originalExt}`;
    }

    // è·¯å¾‘
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');

    const path = `images/${year}/${month}/${rawName}`;
    const metadataPath = `metadata/${year}/${month}/${rawName}.json`;

    const token = localStorage.getItem('github_token');
    if (!token) return alert("Token éºå¤±ï¼Œè«‹é‡æ–°è¼¸å…¥");

    // ä¸Šå‚³åœ–ç‰‡
    const uploadImage = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `upload ${rawName}`,
        content: base64
      })
    });

    if (!uploadImage.ok) {
      alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™èˆ‡ Token');
      return;
    }

    // ä¸Šå‚³ metadata
    const metadata = {
      filename: rawName,
      description,
      uploaded_at: new Date().toISOString()
    };

    await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${metadataPath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `add metadata for ${rawName}`,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(metadata, null, 2))))
      })
    });

    // é¡¯ç¤ºçµæœï¼ˆç¢ºä¿å‰¯æª”ååœ¨ URL ä¸­ï¼‰
    const cdnURL = `https://cdn.jsdelivr.net/gh/${username}/${repo}@${branch}/${path}`;

    document.getElementById('result').innerHTML = `
      <p>åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼</p>
      <div class="urlbox"><strong>Markdownï¼š</strong><br>![](${cdnURL})</div>
      <img src="${cdnURL}" />
    `;
  };
  reader.readAsDataURL(file);
}
  </script>
</body>
</html>
